<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多教室赛事评分系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            background: linear-gradient(90deg, #8f94fb, #4e54c8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .main-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 40px 0;
        }
        
        .menu-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .menu-card:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        
        .menu-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #8f94fb;
        }
        
        .menu-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .menu-desc {
            font-size: 1.1rem;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        h2 {
            font-size: 2rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            color: #8f94fb;
        }
        
        /* 通用样式 */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: #4e54c8;
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .status-success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
        }
        
        .status-error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }
        
        /* 大屏幕展示样式 */
        .display-container {
            display: flex;
            flex-direction: column;
            height: 70vh;
            position: relative;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        .team-display {
            padding: 40px 30px 20px;
            text-align: center;
        }
        
        .team-display-id {
            font-size: 4rem;
            font-weight: bold;
            color: #8f94fb;
            text-shadow: 0 0 10px rgba(143, 148, 251, 0.5);
        }
        
        .team-display-name {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .team-display-type {
            font-size: 1.8rem;
            padding: 8px 25px;
            border-radius: 30px;
            display: inline-block;
        }
        
        .creative {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .startup {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }
        
        .public {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
        
        .judges-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 30px;
            padding: 40px;
            margin-top: auto;
        }
        
        .judge {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .judge-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            border: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .judge.completed .judge-avatar {
            background: #4e54c8;
            border-color: #8f94fb;
            box-shadow: 0 0 20px rgba(143, 148, 251, 0.7);
            transform: scale(1.1);
        }
        
        .judge-id {
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        .progress-indicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 1.5rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 30px;
        }
        
        .progress-value {
            font-weight: bold;
            color: #8f94fb;
        }
        
        .average-score {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem;
            font-weight: bold;
            color: #4e54c8;
            text-shadow: 0 0 20px rgba(143, 148, 251, 0.8);
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .adjusted-score {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: bold;
            color: #9b59b6;
            text-shadow: 0 0 20px rgba(155, 89, 182, 0.8);
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .score-label {
            font-size: 2rem;
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.5s;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            width: 100%;
        }
        
        .average-score.show,
        .adjusted-score.show,
        .score-label.show {
            opacity: 1;
        }
        
        /* 评委打分样式 */
        .judge-login {
            max-width: 500px;
            margin: 40px auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .judge-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .judge-scoring {
            display: none;
        }
        
        .team-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .team-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .scoring-form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .criteria-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .criteria-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .range-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .range-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #8f94fb;
        }
        
        input[type="range"] {
            flex: 1;
            height: 10px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #8f94fb;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #4e54c8;
        }
        
        .total-score {
            font-size: 1.4rem;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .score-value {
            font-size: 2rem;
            color: #8f94fb;
            display: block;
            margin-top: 5px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        /* 赛事编辑样式 */
        .classroom-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .classroom-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
        }
        
        .classroom-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .classroom-title {
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        .classroom-id {
            font-size: 1.1rem;
            background: #4e54c8;
            padding: 4px 12px;
            border-radius: 20px;
        }
        
        .teams-management {
            margin-top: 30px;
        }
        
        .team-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .team-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }
        
        .team-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .team-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .team-id {
            font-weight: bold;
            color: #8f94fb;
        }
        
        .team-type {
            font-size: 0.9rem;
            padding: 3px 10px;
            border-radius: 20px;
        }
        
        .judge-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .judge-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .judge-avatar-small {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 10px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-menu {
                grid-template-columns: 1fr;
            }
            
            .display-container {
                height: 60vh;
            }
            
            .team-display-id {
                font-size: 3rem;
            }
            
            .team-display-name {
                font-size: 2.5rem;
            }
            
            .judges-container {
                gap: 15px;
                padding: 20px;
            }
            
            .judge-avatar {
                width: 70px;
                height: 70px;
                font-size: 1.8rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .average-score, .adjusted-score {
                font-size: 4rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>多教室赛事评分系统</h1>
            <p class="subtitle">支持大屏幕展示、评委评分和赛事编辑功能，五个教室独立管理</p>
        </header>
        
        <!-- 主菜单 -->
        <div id="main-menu" class="active">
            <div class="main-menu">
                <div class="menu-card" data-tab="display">
                    <div class="menu-icon">
                        <i class="fas fa-tv"></i>
                    </div>
                    <div class="menu-title">大屏幕展示</div>
                    <div class="menu-desc">在教室大屏幕上展示团队信息和评分结果</div>
                </div>
                
                <div class="menu-card" data-tab="judge">
                    <div class="menu-icon">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="menu-title">评委评分</div>
                    <div class="menu-desc">评委登录后对团队进行评分</div>
                </div>
                
                <div class="menu-card" data-tab="event">
                    <div class="menu-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="menu-title">赛事编辑</div>
                    <div class="menu-desc">管理评委和团队信息</div>
                </div>
            </div>
        </div>
        
        <!-- 状态消息 -->
        <div id="status-message" class="status-message"></div>
        
        <!-- 大屏幕展示端 -->
        <div id="display-tab" class="tab-content">
            <div class="back-btn" onclick="showMainMenu()">
                <i class="fas fa-arrow-left"></i> 返回主菜单
            </div>
            <h2><i class="fas fa-tv"></i> 大屏幕展示</h2>
            
            <div class="control-panel">
                <select id="display-classroom" class="btn btn-secondary">
                    <option value="1">教室 1</option>
                    <option value="2">教室 2</option>
                    <option value="3">教室 3</option>
                    <option value="4">教室 4</option>
                    <option value="5">教室 5</option>
                </select>
                <button id="prev-team" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 上一个团队
                </button>
                <button id="next-team" class="btn btn-secondary">
                    下一个团队 <i class="fas fa-arrow-right"></i>
                </button>
                <button id="show-score" class="btn btn-primary">
                    <i class="fas fa-calculator"></i> 显示平均分
                </button>
                <button id="show-adjusted-score" class="btn btn-primary">
                    <i class="fas fa-star-half-alt"></i> 显示修正平均分
                </button>
            </div>
            
            <div class="display-container">
                <div class="team-display">
                    <div class="team-display-id">T-001</div>
                    <div class="team-display-name">创新先锋队</div>
                    <div class="team-display-type creative">创意组</div>
                </div>
                
                <div class="judges-container">
                    <!-- 评委头像将通过JS动态生成 -->
                </div>
                
                <div class="progress-indicator">
                    完成评分: <span class="progress-value">0</span>/<span id="total-judges">0</span>
                </div>
                
                <div class="score-label">平均分</div>
                <div class="average-score">0.0</div>
                <div class="adjusted-score">0.0</div>
            </div>
        </div>
        
        <!-- 评委评分端 -->
        <div id="judge-tab" class="tab-content">
            <div class="back-btn" onclick="showMainMenu()">
                <i class="fas fa-arrow-left"></i> 返回主菜单
            </div>
            <h2><i class="fas fa-clipboard-check"></i> 评委评分</h2>
            
            <div class="judge-login">
                <h3>评委登录</h3>
                <p>请输入您的评委编号和选择要评分的教室</p>
                
                <div class="judge-form">
                    <div class="form-group">
                        <label for="judge-id">评委编号</label>
                        <input type="text" id="judge-id" placeholder="例如: J-001">
                    </div>
                    
                    <div class="form-group">
                        <label for="judge-classroom">选择教室</label>
                        <select id="judge-classroom">
                            <option value="1">教室 1</option>
                            <option value="2">教室 2</option>
                            <option value="3">教室 3</option>
                            <option value="4">教室 4</option>
                            <option value="5">教室 5</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" id="login-btn">
                        <i class="fas fa-sign-in-alt"></i> 登录并开始评分
                    </button>
                </div>
            </div>
            
            <div class="judge-scoring">
                <div class="team-info">
                    <div class="team-name">创新先锋队</div>
                    <div>团队编号: <span class="team-id">T-001</span> | 组别: <span class="team-type creative">创意组</span></div>
                </div>
                
                <div class="scoring-form">
                    <!-- 评分表将通过JS动态生成 -->
                </div>
                
                <div class="total-score">
                    总分: <span class="score-value">0</span>/100
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="prev-team-btn">
                        <i class="fas fa-arrow-left"></i> 上一个团队
                    </button>
                    <button class="btn btn-primary" id="submit-score">
                        提交评分 <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-secondary" id="next-team-btn">
                        下一个团队 <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 赛事编辑端 -->
        <div id="event-tab" class="tab-content">
            <div class="back-btn" onclick="showMainMenu()">
                <i class="fas fa-arrow-left"></i> 返回主菜单
            </div>
            <h2><i class="fas fa-cog"></i> 赛事编辑</h2>
            
            <div class="control-panel">
                <select id="edit-classroom" class="btn btn-secondary">
                    <option value="1">教室 1</option>
                    <option value="2">教室 2</option>
                    <option value="3">教室 3</option>
                    <option value="4">教室 4</option>
                    <option value="5">教室 5</option>
                </select>
            </div>
            
            <div class="judges-management">
                <h3><i class="fas fa-user-friends"></i> 评委管理</h3>
                <div class="judge-list" id="judge-list">
                    <!-- 评委列表将通过JS动态生成 -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" id="add-judge-btn">
                        <i class="fas fa-plus"></i> 添加评委
                    </button>
                </div>
            </div>
            
            <div class="teams-management" style="margin-top: 40px;">
                <h3><i class="fas fa-users"></i> 团队管理</h3>
                <div class="team-list" id="team-list">
                    <!-- 团队列表将通过JS动态生成 -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" id="add-team-btn">
                        <i class="fas fa-plus"></i> 添加团队
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // 导入Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDocs, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";

        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyBl8dQU5NMTWAqBNWqArp8mgIQ_ehiEc9A",
            authDomain: "system-450f3.firebaseapp.com",
            projectId: "system-450f3",
            storageBucket: "system-450f3.firebasestorage.app",
            messagingSenderId: "450068189607",
            appId: "1:450068189607:web:07d656cae50203edd7a682",
            measurementId: "G-RJ9M424D6R"
        };

        // 初始化Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        
        // 全局变量
        let currentClassroom = 1;
        let currentTeamIndex = 0;
        let judges = [];
        let teams = [];
        let scores = [];
        let currentJudge = null;
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 主菜单功能
            document.querySelectorAll('.menu-card').forEach(card => {
                card.addEventListener('click', function() {
                    const tab = this.dataset.tab;
                    showTab(tab);
                });
            });
            
            // 大屏幕控制按钮
            document.getElementById('prev-team').addEventListener('click', function() {
                currentTeamIndex = Math.max(0, currentTeamIndex - 1);
                renderDisplay();
            });
            
            document.getElementById('next-team').addEventListener('click', function() {
                currentTeamIndex = Math.min(teams.length - 1, currentTeamIndex + 1);
                renderDisplay();
            });
            
            // 显示平均分按钮
            document.getElementById('show-score').addEventListener('click', function() {
                document.querySelector('.score-label').textContent = "平均分";
                document.querySelector('.score-label').classList.add('show');
                document.querySelector('.average-score').classList.add('show');
                document.querySelector('.adjusted-score').classList.remove('show');
            });
            
            // 显示修正平均分按钮
            document.getElementById('show-adjusted-score').addEventListener('click', function() {
                document.querySelector('.score-label').textContent = "修正平均分 (去掉最高最低分)";
                document.querySelector('.score-label').classList.add('show');
                document.querySelector('.average-score').classList.remove('show');
                document.querySelector('.adjusted-score').classList.add('show');
            });
            
            // 评委登录按钮
            document.getElementById('login-btn').addEventListener('click', loginJudge);
            
            // 评委打分控制按钮
            document.getElementById('prev-team-btn').addEventListener('click', function() {
                currentTeamIndex = Math.max(0, currentTeamIndex - 1);
                renderScoringForm();
            });
            
            document.getElementById('next-team-btn').addEventListener('click', function() {
                currentTeamIndex = Math.min(teams.length - 1, currentTeamIndex + 1);
                renderScoringForm();
            });
            
            document.getElementById('submit-score').addEventListener('click', function() {
                saveScore();
            });
            
            // 赛事编辑按钮
            document.getElementById('add-judge-btn').addEventListener('click', function() {
                addNewJudge();
            });
            
            document.getElementById('add-team-btn').addEventListener('click', function() {
                addNewTeam();
            });
            
            // 教室选择监听
            document.getElementById('display-classroom').addEventListener('change', function() {
                currentClassroom = parseInt(this.value);
                loadClassroomData(currentClassroom);
            });
            
            document.getElementById('edit-classroom').addEventListener('change', function() {
                currentClassroom = parseInt(this.value);
                loadClassroomData(currentClassroom);
            });
            
            document.getElementById('judge-classroom').addEventListener('change', function() {
                currentClassroom = parseInt(this.value);
            });
            
            // 初始加载数据
            loadClassroomData(1);
        });
        
        // 加载教室数据
        async function loadClassroomData(classroomId) {
            try {
                // 加载评委
                const judgesRef = collection(db, `classrooms/${classroomId}/judges`);
                onSnapshot(judgesRef, (snapshot) => {
                    judges = [];
                    snapshot.forEach(doc => {
                        judges.push({ id: doc.id, ...doc.data() });
                    });
                    
                    if (document.getElementById('event-tab').classList.contains('active')) {
                        renderJudgesList();
                    }
                    
                    if (document.getElementById('display-tab').classList.contains('active')) {
                        renderDisplay();
                    }
                });
                
                // 加载团队
                const teamsRef = collection(db, `classrooms/${classroomId}/teams`);
                onSnapshot(teamsRef, (snapshot) => {
                    teams = [];
                    snapshot.forEach(doc => {
                        teams.push({ id: doc.id, ...doc.data() });
                    });
                    
                    if (document.getElementById('event-tab').classList.contains('active')) {
                        renderTeamList();
                    }
                    
                    if (document.getElementById('display-tab').classList.contains('active')) {
                        renderDisplay();
                    }
                    
                    if (document.querySelector('.judge-scoring').style.display === 'block') {
                        renderScoringForm();
                    }
                });
                
                // 加载评分
                const scoresRef = collection(db, `classrooms/${classroomId}/scores`);
                onSnapshot(scoresRef, (snapshot) => {
                    scores = [];
                    snapshot.forEach(doc => {
                        scores.push({ id: doc.id, ...doc.data() });
                    });
                    
                    if (document.getElementById('display-tab').classList.contains('active')) {
                        renderDisplay();
                    }
                });
                
                showStatusMessage(`教室 ${classroomId} 数据已加载`, 'success');
            } catch (error) {
                console.error("加载数据失败: ", error);
                showStatusMessage(`加载数据失败: ${error.message}`, 'error');
            }
        }
        
        // 显示主菜单
        function showMainMenu() {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById('main-menu').classList.add('active');
        }
        
        // 显示指定标签页
        function showTab(tabName) {
            document.getElementById('main-menu').classList.remove('active');
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'display') {
                renderDisplay();
            } else if (tabName === 'event') {
                loadClassroomData(currentClassroom);
            }
        }
        
        // 评委登录
        async function loginJudge() {
            const judgeId = document.getElementById('judge-id').value.trim();
            const classroom = document.getElementById('judge-classroom').value;
            
            if (!judgeId) {
                showStatusMessage('请输入评委编号', 'error');
                return;
            }
            
            // 检查评委是否存在
            const judgesRef = collection(db, `classrooms/${classroom}/judges`);
            const querySnapshot = await getDocs(judgesRef);
            let judgeExists = false;
            
            querySnapshot.forEach(doc => {
                if (doc.id === judgeId) {
                    judgeExists = true;
                }
            });
            
            if (!judgeExists) {
                showStatusMessage('评委编号不存在，请添加评委', 'error');
                return;
            }
            
            currentJudge = judgeId;
            currentClassroom = parseInt(classroom);
            
            // 显示评分界面
            document.querySelector('.judge-login').style.display = 'none';
            document.querySelector('.judge-scoring').style.display = 'block';
            
            // 加载该教室的团队数据
            const teamsRef = collection(db, `classrooms/${currentClassroom}/teams`);
            const teamsSnapshot = await getDocs(teamsRef);
            teams = [];
            teamsSnapshot.forEach(doc => {
                teams.push({ id: doc.id, ...doc.data() });
            });
            
            currentTeamIndex = 0;
            renderScoringForm();
        }
        
        // 渲染评委列表（赛事编辑）
        function renderJudgesList() {
            const container = document.getElementById('judge-list');
            container.innerHTML = '';
            
            if (judges.length === 0) {
                container.innerHTML = '<div class="no-judges">该教室还没有评委</div>';
                return;
            }
            
            judges.forEach(judge => {
                const judgeElement = document.createElement('div');
                judgeElement.className = 'judge-item';
                judgeElement.innerHTML = `
                    <div class="judge-avatar-small">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="judge-id">${judge.id}</div>
                    <button class="btn btn-sm btn-secondary delete-judge" data-id="${judge.id}" style="margin-top: 10px;">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                `;
                container.appendChild(judgeElement);
            });
            
            // 添加删除评委事件
            document.querySelectorAll('.delete-judge').forEach(button => {
                button.addEventListener('click', async function() {
                    const judgeId = this.dataset.id;
                    if (confirm(`确定要删除评委 ${judgeId} 吗？`)) {
                        try {
                            await deleteDoc(doc(db, `classrooms/${currentClassroom}/judges`, judgeId));
                            showStatusMessage(`评委 ${judgeId} 已删除`, 'success');
                        } catch (error) {
                            console.error("删除评委失败: ", error);
                            showStatusMessage(`删除评委失败: ${error.message}`, 'error');
                        }
                    }
                });
            });
        }
        
        // 渲染团队列表（赛事编辑）
        function renderTeamList() {
            const container = document.getElementById('team-list');
            container.innerHTML = '';
            
            if (teams.length === 0) {
                container.innerHTML = '<div class="no-teams">该教室还没有团队</div>';
                return;
            }
            
            teams.forEach(team => {
                const teamElement = document.createElement('div');
                teamElement.className = 'team-item';
                teamElement.innerHTML = `
                    <div class="team-header">
                        <div class="team-id">${team.id}</div>
                        <div class="team-type ${team.type}">${getTypeName(team.type)}</div>
                    </div>
                    <div class="team-name">${team.name}</div>
                    <div class="team-actions" style="margin-top: 10px;">
                        <button class="btn btn-sm btn-secondary edit-team" data-id="${team.id}">编辑</button>
                        <button class="btn btn-sm btn-secondary delete-team" data-id="${team.id}">删除</button>
                    </div>
                `;
                container.appendChild(teamElement);
            });
            
            // 添加编辑和删除团队事件
            document.querySelectorAll('.edit-team').forEach(button => {
                button.addEventListener('click', function() {
                    const teamId = this.dataset.id;
                    const team = teams.find(t => t.id === teamId);
                    if (team) {
                        const newName = prompt('请输入团队名称:', team.name);
                        if (newName && newName.trim() !== '') {
                            updateTeam(teamId, newName.trim());
                        }
                    }
                });
            });
            
            document.querySelectorAll('.delete-team').forEach(button => {
                button.addEventListener('click', function() {
                    const teamId = this.dataset.id;
                    if (confirm(`确定要删除团队 ${teamId} 吗？`)) {
                        deleteTeam(teamId);
                    }
                });
            });
        }
        
        // 添加新评委
        async function addNewJudge() {
            try {
                // 生成评委ID
                const judgeCount = judges.length;
                const newId = `J-${(judgeCount + 1).toString().padStart(3, '0')}`;
                
                // 添加到Firebase
                await setDoc(doc(db, `classrooms/${currentClassroom}/judges`, newId), {
                    createdAt: new Date().toISOString()
                });
                
                showStatusMessage(`评委 ${newId} 已添加`, 'success');
            } catch (error) {
                console.error("添加评委失败: ", error);
                showStatusMessage(`添加评委失败: ${error.message}`, 'error');
            }
        }
        
        // 添加新团队
        async function addNewTeam() {
            const name = prompt("请输入团队名称:");
            if (!name || name.trim() === '') return;
            
            const type = prompt("请选择组别 (1-创意组, 2-创业组, 3-公益组):");
            let typeValue = '';
            
            switch(type) {
                case '1': typeValue = 'creative'; break;
                case '2': typeValue = 'startup'; break;
                case '3': typeValue = 'public'; break;
                default:
                    alert('无效的选择，请重新输入');
                    return;
            }
            
            try {
                // 生成团队ID
                const teamCount = teams.length;
                const newId = `T-${(teamCount + 1).toString().padStart(3, '0')}`;
                
                // 添加到Firebase
                await setDoc(doc(db, `classrooms/${currentClassroom}/teams`, newId), {
                    name: name.trim(),
                    type: typeValue
                });
                
                showStatusMessage(`团队 ${newId} 已添加`, 'success');
            } catch (error) {
                console.error("添加团队失败: ", error);
                showStatusMessage(`添加团队失败: ${error.message}`, 'error');
            }
        }
        
        // 更新团队信息
        async function updateTeam(teamId, newName) {
            try {
                await updateDoc(doc(db, `classrooms/${currentClassroom}/teams`, teamId), {
                    name: newName
                });
                
                showStatusMessage(`团队 ${teamId} 已更新`, 'success');
            } catch (error) {
                console.error("更新团队失败: ", error);
                showStatusMessage(`更新团队失败: ${error.message}`, 'error');
            }
        }
        
        // 删除团队
        async function deleteTeam(teamId) {
            try {
                await deleteDoc(doc(db, `classrooms/${currentClassroom}/teams`, teamId));
                showStatusMessage(`团队 ${teamId} 已删除`, 'success');
            } catch (error) {
                console.error("删除团队失败: ", error);
                showStatusMessage(`删除团队失败: ${error.message}`, 'error');
            }
        }
        
        // 渲染评分表单
        function renderScoringForm() {
            if (teams.length === 0) {
                document.querySelector('.team-name').textContent = "该教室暂无团队";
                return;
            }
            
            const team = teams[currentTeamIndex];
            
            document.querySelector('.team-name').textContent = team.name;
            document.querySelector('.team-id').textContent = team.id;
            const typeElement = document.querySelector('.team-type');
            typeElement.textContent = getTypeName(team.type);
            typeElement.className = `team-type ${team.type}`;
            
            // 根据团队类型生成评分表
            const formContainer = document.querySelector('.scoring-form');
            formContainer.innerHTML = '';
            
            let criteria = [];
            
            switch(team.type) {
                case 'creative':
                    criteria = [
                        { name: '个人成长', key: 'personalGrowth', max: 30 },
                        { name: '项目创新', key: 'projectInnovation', max: 30 },
                        { name: '产业价值', key: 'industrialValue', max: 25 },
                        { name: '团队协作', key: 'teamCollaboration', max: 15 }
                    ];
                    break;
                case 'startup':
                    criteria = [
                        { name: '个人成长', key: 'personalGrowth', max: 25 },
                        { name: '项目创新', key: 'projectInnovation', max: 30 },
                        { name: '产业价值', key: 'industrialValue', max: 30 },
                        { name: '团队协作', key: 'teamCollaboration', max: 15 }
                    ];
                    break;
                case 'public':
                    criteria = [
                        { name: '个人成长', key: 'personalGrowth', max: 30 },
                        { name: '公益价值', key: 'publicValue', max: 10 },
                        { name: '项目创新', key: 'projectInnovation', max: 20 },
                        { name: '发展前景', key: 'developmentProspects', max: 20 },
                        { name: '团队协作', key: 'teamCollaboration', max: 20 }
                    ];
                    break;
            }
            
            // 创建评分项
            criteria.forEach(criterion => {
                const card = document.createElement('div');
                card.className = 'criteria-card';
                card.innerHTML = `
                    <h3>${criterion.name} (${criterion.max}分)</h3>
                    <div class="range-container">
                        <input type="range" min="0" max="${criterion.max}" value="0" 
                               data-criterion="${criterion.key}" class="score-input">
                        <span class="range-value">0</span>
                    </div>
                `;
                formContainer.appendChild(card);
            });
            
            // 添加事件监听器
            document.querySelectorAll('.score-input').forEach(input => {
                input.addEventListener('input', function() {
                    // 更新显示的值
                    this.nextElementSibling.textContent = this.value;
                    
                    // 计算总分
                    calculateTotalScore();
                });
            });
            
            // 初始化总分
            calculateTotalScore();
        }
        
        // 计算总分
        function calculateTotalScore() {
            let total = 0;
            document.querySelectorAll('.score-input').forEach(input => {
                total += parseInt(input.value);
            });
            
            document.querySelector('.score-value').textContent = total;
        }
        
        // 保存评分
        async function saveScore() {
            const team = teams[currentTeamIndex];
            if (!team) return;
            
            // 收集评分数据
            const scoreData = {
                judgeId: currentJudge,
                teamId: team.id,
                classroom: currentClassroom,
                timestamp: new Date().toISOString()
            };
            
            // 获取所有评分项
            document.querySelectorAll('.score-input').forEach(input => {
                const criterion = input.dataset.criterion;
                scoreData[criterion] = parseInt(input.value);
            });
            
            // 计算总分
            scoreData.total = parseInt(document.querySelector('.score-value').textContent);
            
            try {
                // 保存到Firebase
                await addDoc(collection(db, `classrooms/${currentClassroom}/scores`), scoreData);
                showStatusMessage(`评分已提交: ${scoreData.total}分`, 'success');
                
                // 自动切换到下一个团队
                setTimeout(() => {
                    if (currentTeamIndex < teams.length - 1) {
                        currentTeamIndex++;
                        renderScoringForm();
                    }
                }, 1500);
            } catch (error) {
                console.error("保存评分失败: ", error);
                showStatusMessage(`保存评分失败: ${error.message}`, 'error');
            }
        }
        
        // 渲染大屏幕展示
        function renderDisplay() {
            if (teams.length === 0) {
                document.querySelector('.team-display-id').textContent = "无团队";
                document.querySelector('.team-display-name').textContent = "请添加团队";
                return;
            }
            
            const team = teams[currentTeamIndex];
            
            // 更新团队信息
            document.querySelector('.team-display-id').textContent = team.id;
            document.querySelector('.team-display-name').textContent = team.name;
            const typeElement = document.querySelector('.team-display-type');
            typeElement.textContent = getTypeName(team.type);
            typeElement.className = `team-display-type ${team.type}`;
            
            // 更新评委状态
            const judgesContainer = document.querySelector('.judges-container');
            judgesContainer.innerHTML = '';
            
            // 显示所有评委
            judges.forEach(judge => {
                // 检查该评委是否已完成评分
                const isCompleted = scores.some(score => 
                    score.judgeId === judge.id && score.teamId === team.id
                );
                
                const judgeElement = document.createElement('div');
                judgeElement.className = `judge ${isCompleted ? 'completed' : ''}`;
                judgeElement.innerHTML = `
                    <div class="judge-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="judge-id">${judge.id}</div>
                `;
                judgesContainer.appendChild(judgeElement);
            });
            
            // 更新进度
            const completedCount = judges.filter(judge => {
                return scores.some(score => 
                    score.judgeId === judge.id && score.teamId === team.id
                );
            }).length;
            
            document.querySelector('.progress-value').textContent = completedCount;
            document.getElementById('total-judges').textContent = judges.length;
            
            // 计算平均分
            const teamScores = scores
                .filter(score => score.teamId === team.id)
                .map(score => score.total);
            
            let averageScore = 0;
            let adjustedScore = 0;
            
            if (teamScores.length > 0) {
                // 计算原始平均分
                const total = teamScores.reduce((sum, score) => sum + score, 0);
                averageScore = (total / teamScores.length).toFixed(1);
                
                // 计算修正平均分（去掉最高分和最低分）
                if (teamScores.length > 2) {
                    const sortedScores = [...teamScores].sort((a, b) => a - b);
                    const trimmedScores = sortedScores.slice(1, -1); // 去掉最高和最低
                    const trimmedTotal = trimmedScores.reduce((sum, score) => sum + score, 0);
                    adjustedScore = (trimmedTotal / trimmedScores.length).toFixed(1);
                } else {
                    adjustedScore = averageScore;
                }
            }
            
            // 更新分数显示
            document.querySelector('.average-score').textContent = averageScore;
            document.querySelector('.adjusted-score').textContent = adjustedScore;
            
            // 默认隐藏所有分数
            document.querySelector('.score-label').classList.remove('show');
            document.querySelector('.average-score').classList.remove('show');
            document.querySelector('.adjusted-score').classList.remove('show');
        }
        
        // 获取组别名称
        function getTypeName(type) {
            switch(type) {
                case 'creative': return '创意组';
                case 'startup': return '创业组';
                case 'public': return '公益组';
                default: return type;
            }
        }
        
        // 显示状态消息
        function showStatusMessage(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>